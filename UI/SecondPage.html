<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Carotid Calcium Scanner</title>
    <link rel="stylesheet" href="styleSecond.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!--This is a page I used to get the icons upload and info in the second page of the UI-->
    <script src="https://kit.fontawesome.com/e3accbbb35.js" crossorigin="anonymous"></script>
    <!-- Here is the connection between the js and html files-->
    <script src="https://unpkg.com/cornerstone-core/dist/cornerstone.min.js"></script>
    <script src="https://unpkg.com/cornerstone-wado-image-loader"></script>
    <script src="https://unpkg.com/dicom-parser"></script>
    <script src="https://unpkg.com/cornerstone-math"></script>
    <script src="https://unpkg.com/cornerstone-tools"></script>
    <script src="https://unpkg.com/hammerjs"></script>
    <script src="../tools.js"></script>
    <script src="../util.js"></script>
    <script>

        cornerstoneWADOImageLoader.external.cornerstone = cornerstone;
        cornerstoneWADOImageLoader.external.dicomParser = dicomParser;
        cornerstoneTools.external.Hammer = Hammer;
        cornerstoneTools.external.cornerstone = cornerstone;
        cornerstoneTools.external.cornerstoneMath = cornerstoneMath;
        segModule = cornerstoneTools.getModule('segmentation');

        var currentTool = '';
        var image1;
        var internalStack; 

        function onDragOver(event) {

            // stop browser processing right away
            event.stopPropagation();
            event.preventDefault();

        };

        function onDrop(event) {

            // stop browser processing right away
            event.stopPropagation();
            event.preventDefault();

            imageIds = [];

            for (var i = 0; i < event.dataTransfer.files.length; i++) {

                var file = event.dataTransfer.files[i];
                imageIds.push(cornerstoneWADOImageLoader.wadouri.fileManager.add(file));

            }

            cornerstone.loadImage(imageIds[0]).then(function (image) {

                image1 = image;
                console.log('Loaded', image);

                cornerstoneTools.init();

                var viewer = document.getElementById('viewer');

                cornerstone.enable(viewer);
                cornerstone.displayImage(viewer, image);
                cornerstone.getViewport(viewer).labelmap = true;


                var stack = {
                    currentImageIdIndex: 0,
                    imageIds: imageIds,
                    labelmaps2D: []
                };

                internalStack = stack;

                cornerstoneTools.addStackStateManager(viewer, ["stack"]);
                cornerstoneTools.addToolState(viewer, "stack", stack);

                cornerstoneTools.addTool(cornerstoneTools.StackScrollMouseWheelTool);
                cornerstoneTools.addTool(ThresholdsBrushTool);
                cornerstoneTools.addTool(cornerstoneTools.ZoomTool);
                cornerstoneTools.addTool(cornerstoneTools.PanTool);
                cornerstoneTools.addTool(cornerstoneTools.LengthTool);

                // This tool allows you to get the area of a circled area using a brush.
                cornerstoneTools.addTool(cornerstoneTools.FreehandRoiTool);

                // Activate tools as needed; default active tool is brush and stack scroll.
                cornerstoneTools.setToolPassive('ThresholdsBrush', { mouseButtonMask: 1 });
                cornerstoneTools.setToolActive('StackScrollMouseWheel', {});
                cornerstoneTools.setToolPassive('Zoom', { mouseButtonMask: 1 });
                cornerstoneTools.setToolPassive('FreehandRoi', { mouseButtonMask: 1 });
                cornerstoneTools.setToolPassive('Pan', { mouseButtonMask: 1 });
                cornerstoneTools.setToolPassive('Length', { mouseButtonMask: 1 });
                currentTool = 'ThresholdsBrush';

            });

        };


        window.onload = function () {

            document.body.addEventListener('dragover', onDragOver);
            document.body.addEventListener('drop', onDrop);
        };
        
        window.onkeyup = function (event) {

            // this was an else if now it is just an if in case we want to change it back to keys on keyboard
            if (event.key == '0') {
                cornerstoneTools.setToolDisabled(currentTool);
                cornerstoneTools.setToolActive('FreehandRoi', { mouseButtonMask: 1 });
                currentTool = 'FreehandRoi';
            }
            else if (event.key == '1') {
                cornerstoneTools.setToolDisabled(currentTool);
                cornerstoneTools.setToolActive('Length', { mouseButtonMask: 1 });
                currentTool = 'Length';
            }

            else if (event.key == '2') {
                var labelMap2D = segModule.getters.labelmap2D(viewer).labelmap2D;
                var image = cornerstone.getImage(viewer);
                var counts = discreteCount(labelMap2D, image);
                console.log("red: " + counts.red);
                console.log("blue: " + counts.blue);
                console.log("green: " + counts.green);
                console.log("purple: " + counts.purple);
                console.log("pink: " + counts.fuchsia);

            }
            else if (event.key == '3') {
                var image = cornerstone.getImage(viewer);
                var labelMap2D = segModule.getters.labelmap2D(viewer).labelmap2D;
                var simpleVolumes = getVolume(labelMap2D, image);
                console.log("red: " + simpleVolumes.red + 'mm\u00B3');
                console.log("blue: " + simpleVolumes.blue + 'mm\u00B3');
                console.log("green: " + simpleVolumes.green + 'mm\u00B3');
                console.log("purple: " + simpleVolumes.purple + 'mm\u00B3');
                console.log("pink: " + simpleVolumes.fuchsia + 'mm\u00B3');
            }

            else if (event.key == '4') {

                var labelMap2D = segModule.getters.labelmap2D(viewer).labelmap2D;
                var image = cornerstone.getImage(viewer);

                var areas = getBrushArea(labelMap2D, image);
                console.log("red brush: " + areas.red + 'mm\u00B2');
                console.log("blue brush: " + areas.blue + 'mm\u00B2');
                console.log("green brush: " + areas.green + 'mm\u00B2');
                console.log("purple brush: " + areas.purple + 'mm\u00B2');
                console.log("pink brush: " + areas.fuchsia + 'mm\u00B2');
            }
            else if (event.key == '5') {
                var labelMap2D = segModule.getters.labelmap2D(viewer).labelmap2D;
                var image = cornerstone.getImage(viewer);
                var densities = getDensity(labelMap2D, image);
                console.log("red: " + densities.red);
                console.log("blue: " + densities.blue);
                console.log("green: " + densities.green);
                console.log("purple: " + densities.purple);
                console.log("pink: " + densities.fuchsia);
            }
            else if (event.key == '6') {
                clearBrushes(viewer);
            }
            else if (event.key == 'q') {
                var labelMap2D = segModule.getters.labelmap2D(viewer).labelmap2D;
                convertToJSON(labelMap2D);
            }
        };
             //else if (event.key == '1') {
            //    cornerstoneTools.setToolDisabled(currentTool);
            //    cornerstoneTools.setToolActive('Pan', { mouseButtonMask: 1 });
            //    currentTool = 'Pan';
            //}

            //if (event.key == '-') {
            //    cornerstoneTools.store.state.tools[1].decreaseBrushSize();
            //} else if (event.key == '=') {
            //    cornerstoneTools.store.state.tools[1].increaseBrushSize();
            //}


            //else if (event.key == '0') {

            //    segModule.setters.decrementActiveSegmentIndex(viewer);

            //    if (segModule.getters.activeSegmentIndex(viewer) == 4) {
            //        segModule.setters.decrementActiveSegmentIndex(viewer);

            //    }

            //    if (segModule.getters.activeSegmentIndex(viewer) == 65535) {
            //        segModule.setters.activeSegmentIndex(viewer, 6);

            //    }
            //}
            //else if (event.key == '9') {


            //    segModule.setters.incrementActiveSegmentIndex(viewer);

            //    if (segModule.getters.activeSegmentIndex(viewer) == 4) {
            //        segModule.setters.incrementActiveSegmentIndex(viewer);
            //    }
            //    if (segModule.getters.activeSegmentIndex(viewer) > 6) {
            //        segModule.setters.activeSegmentIndex(viewer, 1);
            //    }
            //}
            //else if (event.key == '1') {

            //    cornerstoneTools.setToolDisabled(currentTool);
            //    cornerstoneTools.setToolActive('ThresholdsBrush', { mouseButtonMask: 1 });
            //    currentTool = 'ThresholdsBrush';

            //}
            //else if (event.key == '2') {
            //    cornerstoneTools.setToolDisabled(currentTool);
            //    cornerstoneTools.setToolActive('Zoom', { mouseButtonMask: 1 });
            //    currentTool = 'Zoom';
            //}
            // cornerstoneTools.getModule('segmentation').setters.incrementActiveSegmentIndex(viewer);

      
    </script>
</head>
    <body>
        <!--The looks:-->
        <div class="back-ground">
            <!--Logo-->
            <img src="imag/logo1.png" class="logo" />
            <!--this is the info button on the top right corner-->
            <a href="info.html">
                <button class="info">
                    <i class="fa fa-info"></i>
                </button>
            </a>
            <!--This created the blue line on top of the page-->
            <hr />
            <div class="Buttons">
                <!--Brush button with onclick functionality. When pressed the +/- and colors are enabled-->
                <p1>Brush</p1>
                <button class="brush" onclick="brushbutton(); enable();">
                    <i class="fa-solid fa-paintbrush"></i>
                </button>
                <!--Brush size buttons (increase and drecrease) with onclick functionality-->
                <p4>Brush Size</p4>
                <!--brush size increase-->
                <button id="Pplus" class="bplus" onclick="increasebrush()">
                   <i class="fa-solid fa-plus"></i>
                </button>
                <!--brush size decrease-->
                <button id="Mminus" class="bminus" onclick="decreasebrush()">
                    <i class="fa-solid fa-minus"></i>
                </button>
                <!--Changing the color of the brush. There are five oprions: Red, Green, Purple, Blue, and Pink-->
                <p5>Brush Color</p5>
                <select id="Color" onchange="changecolor()">
                    <option value="1">Default: Red</option>
                    <option value="2">Green</option>
                    <option value="3">Purple</option>
                    <option value="68">Blue</option>
                    <option value="6">Pink</option>
                </select>
                <!--Zoom button with onclick functionality. It disables the increase decrease of the brush size, as well as the color picking-->
                <p2>Zoom</p2>
                <button class="zoom" onclick="zoombutton(); disable();">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
                <!--Pan button. It disables the increase decrease of the brush size, as well as the color picking -->
                <p3>Pan</p3>
                <button class="pan" onclick="panbutton(); disable();">
                    <i class="fa-solid fa-arrows-up-down-left-right"></i>
                </button>
                <p7>Clear Brush</p7>
                <button class="clear" onclick="clearbutton()">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>

            <!--Useful message for the user-->
            <p6>Drag & Drop</p6>

            
            <!--viewer for drag and drop-->>
            <div class="viewer">
                <!--<div class="overlay">
        </div>-->
                <p id="viewer"></p>

            </div>
        </div>
    </body>

</html>
