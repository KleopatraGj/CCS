<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Carotid Calcium Scanner</title>
    <link rel="stylesheet" href="styleSecond.css" />
    <!--This is a page I used to get the icons upload and info in the second page of the UI-->
    <script src="https://kit.fontawesome.com/e3accbbb35.js" crossorigin="anonymous"></script>
    <!-- Here is the connection between the js and html files-->
    <script src="https://unpkg.com/cornerstone-core/dist/cornerstone.min.js"></script>
    <script src="https://unpkg.com/cornerstone-wado-image-loader"></script>
    <script src="https://unpkg.com/dicom-parser"></script>
    <script src="https://unpkg.com/cornerstone-math"></script>
    <script src="https://unpkg.com/cornerstone-tools"></script>
    <script src="https://unpkg.com/hammerjs"></script>
    <script>
        cornerstoneWADOImageLoader.external.cornerstone = cornerstone;
        cornerstoneWADOImageLoader.external.dicomParser = dicomParser;
        cornerstoneTools.external.cornerstoneTools = cornerstoneTools;

        function onDragOver(event) {

            // stop browser processing right away
            event.stopPropagation();
            event.preventDefault();

        };

        function onDrop(event) {

            // stop browser processing right away
            event.stopPropagation();
            event.preventDefault();

            // var file = event.dataTransfer.files[0];
            var files = event.dataTransfer.files;
            console.log("Files uploaded: " + files.length);
            console.log(files);
            var imageIDs = new Array();

            for (let i = 0; i < files.length; i++) {
                console.log("We are on file: " + i);
                console.log("This is the current file contents:")
                console.log(files[i]);

                imageIDs.push(cornerstoneWADOImageLoader.wadouri.fileManager.add(files[i]));
                console.log("This is the curent imageID: " + imageIDs);
            }


            const StackScrollMouseWheelTool = cornerstoneTools.StackScrollMouseWheelTool;


            cornerstone.loadImage(imageIDs[0]).then(function (image) {

                // Failsafe check
                console.log('Loaded', image);

                // Inititialize tools DO NOT MOVE THIS IT MAKES EVERYTHING BREAK 
                cornerstoneTools.init();

                var viewer = document.getElementById('viewer');
                viewer.focus();

                // Enable viewer and display.
                cornerstone.enable(viewer);
                cornerstone.displayImage(viewer, image);

                
                // Instantiate stack and stackstatemanager. 
                const stack = {
                    currentImageIdIndex: 0,
                    imageIDs
                }

                console.log("THIS IS THE STACK", stack);

                cornerstoneTools.addStackStateManager(viewer, ['stack']);
                cornerstoneTools.addToolState(viewer, 'stack', stack);

                // Add tool and set to active. 
                cornerstoneTools.addTool(StackScrollMouseWheelTool);
                cornerstoneTools.setToolActive('StackScrollMouseWheel', {} );
//                console.log("Active?", (cornerstoneTools.setToolActive('StackScrollMouseWheel', {}) == true));



            });

            cornerstoneTools.addTool(StackScrollMouseWheelTool);
            cornerstoneTools.setToolActive('StackScrollMouseWheel', {mouseButtonMask : 1});
            console.log("Active?", (cornerstoneTools.setToolActive('StackScrollMouseWheel', {}) == true));

        };

        window.onload = function () {

            document.body.addEventListener('dragover', onDragOver);
            document.body.addEventListener('drop', onDrop);
        };

    </script>
</head>
    <body>
        <!--The looks:-->
        <div class="back-ground">
            <!--The class "logoandmore" contains the logo, all the different buttons, and the gif that will play as
            the user is uploading the files ready for some scanning-->
            <div class="logoandmore">
                <!--Logo-->
                <img src="imag/logo1.png" class="logo" />
                <!--Similar with the upload button above-->
                <div class="info">
                    <i class="fa-solid fa-info"></i>
                </div>
            </div>
            <!--viewer for drag and drop-->>
            <div class ="viewer">
                <p id="viewer" ></p>        
            </div>
    </body>

</html>
